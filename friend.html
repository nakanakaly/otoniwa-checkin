<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ç´¹ä»‹ã§æ¥ãŸäººï¼šç„¡æ–™ãƒ‰ãƒªãƒ³ã‚¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      background:#f6f6f6;
      margin:0;
      padding:14px 12px 18px;
      text-align:center;
      color:#111;
    }
    .wrap{max-width:640px;margin:0 auto;}
    .card{
      background:#fff;
      border-radius:26px;
      padding:18px 16px 16px;
      box-shadow:0 10px 30px rgba(0,0,0,.07);
    }
    .title{font-size:22px;font-weight:900;margin:0 0 8px;}
    .lead{font-size:16px;font-weight:900;margin:4px 0 8px;line-height:1.35;}
    .box{
      background:#f3f3f3;
      border-radius:14px;
      padding:12px;
      text-align:left;
      font-size:14px;
      font-weight:900;
      line-height:1.35;
      margin:10px 0 10px;
    }
    .row{display:flex;gap:8px;margin-top:8px;}
    input{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #ccc;
      font-size:16px;
      font-weight:900;
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:#111;
      color:#fff;
      font-weight:900;
      font-size:15px;
    }
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
    .note{
      background:#fff3cd;
      border-radius:14px;
      padding:11px 12px;
      font-size:14px;
      font-weight:900;
      margin:10px 0 8px;
      line-height:1.35;
    }
    .pill{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      background:#eef3ff;
      font-weight:900;
    }
    .qr{
      width:100%;
      max-width:250px;
      margin:6px auto 0;
      display:block;
    }
    .muted{font-size:13px;color:#666;margin:6px 0;}
    .footer{font-size:13px;color:#888;margin-top:6px;}

    @media (max-height: 700px) {
      .title{font-size:21px;}
      .lead{font-size:15px;}
      .box{font-size:13px; padding:11px;}
      .note{font-size:13px; padding:10px 11px;}
      .qr{max-width:235px;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="title">ğŸŸ ç´¹ä»‹ã§æ¥ãŸäººï¼šç„¡æ–™ãƒ‰ãƒªãƒ³ã‚¯</div>
    <div class="lead">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ï¼‰ã‚’å…¥ã‚Œã¦<br>è‡ªåˆ†ã®QRã‚’å‡ºã—ã¦ã‚¹ã‚¯ã‚·ãƒ§ã—ã¦ã­</div>

    <div class="box">
      ç´¹ä»‹ã—ã¦ãã‚ŒãŸäººã®ã€Œç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ï¼‰ã€ã‚’å…¥åŠ›ã—ã¦ã€Œç™ºè¡Œã€<br>
      â†’ å‡ºã¦ããŸQRã‚’ã‚¹ã‚¿ãƒƒãƒ•ã«è¦‹ã›ã‚‹ã¨ <strong>1æ¯ç„¡æ–™</strong>
      <div class="row">
        <input id="refInput" class="mono" placeholder="ä¾‹ï¼š6nx8" maxlength="4" inputmode="text" autocomplete="off" autocapitalize="characters">
        <button id="issueBtn" type="button">ç™ºè¡Œ</button>
      </div>
    </div>

    <div id="result" style="display:none;">
      <div class="note">
        ã“ã®ç”»é¢ã‚’ã‚¹ã‚¯ã‚·ãƒ§ä¿å­˜ã—ã¦ã­<br>
        <strong>ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™ï¼ˆ1å›ï¼‰</strong> ğŸº
      </div>

      <div class="muted">â€»ã‚¹ã‚¿ãƒƒãƒ•ãŒèª­ã¿å–ã‚Šã¾ã™</div>
      <div class="muted">ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼š<span class="pill mono" id="refShown">----</span></div>
      <div class="muted">ã‚¹ã‚¿ãƒƒãƒ•ç¢ºèªç”¨ï¼š<span class="pill mono" id="codeLine">code: ----</span></div>

      <img id="qr" class="qr" alt="ã‚¹ã‚¿ãƒƒãƒ•èª­ã¿å–ã‚Šç”¨QR">
      <div class="footer">ã“ã®ç”»é¢ã¯å†ç™ºè¡Œã§ãã¾ã›ã‚“</div>
    </div>
  </div>
</div>

<script>
  const params = new URLSearchParams(location.search);
  let spot = (params.get("spot") || "uk")
    .toLowerCase()
    .replace(/[^a-z0-9]/g,"")
    .slice(0,2);

  const alphabet = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ";
  const rand4 = () => {
    let s = "";
    for(let i=0;i<4;i++) s += alphabet[Math.floor(Math.random()*alphabet.length)];
    return s;
  };

  const cleanRef = (v) => (v || "")
    .toUpperCase()
    .replace(/[^A-Z0-9]/g,"")
    .slice(0,4);

  function issue(ref){
    // æ–°è¦æ¥å ´è€…è‡ªèº«ã®uid
    const uid = rand4();
    const token = uid + spot;

    // ç™ºè¡Œæ™‚åˆ»ï¼ˆUnixåˆ†â†’base36ï¼‰
    const issuedMin = Math.floor(Date.now() / 60000);
    const t = issuedMin.toString(36);

    // redeem URLï¼ˆç´¹ä»‹è€…uidã¯ r= ã§æ¸¡ã™ï¼‰
    const base = location.origin + location.pathname.replace(/[^\/]+$/, "");
    const u = new URL(base + "redeem.html");
    u.searchParams.set("c", token);
    u.searchParams.set("t", t);
    u.searchParams.set("r", ref); // â˜…ç´¹ä»‹è€…uidï¼ˆ4æ–‡å­—ï¼‰
    const redeemUrl = u.toString();

    // è¡¨ç¤º
    document.getElementById("refShown").textContent = ref.toLowerCase();
    document.getElementById("codeLine").textContent = `code: ${uid.toLowerCase()}-${spot}`;
    document.getElementById("qr").src =
      "https://barcode.tec-it.com/barcode.ashx" +
      "?data=" + encodeURIComponent(redeemUrl) +
      "&code=QRCode";

    document.getElementById("result").style.display = "block";
  }

  document.getElementById("issueBtn").addEventListener("click", () => {
    const ref = cleanRef(document.getElementById("refInput").value);
    if(ref.length !== 4){
      alert("ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ï¼‰ã‚’å…¥ã‚Œã¦ã­");
      return;
    }
    issue(ref);
  });
</script>
</body>
</html>
