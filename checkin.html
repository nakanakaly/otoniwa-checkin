<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ¬¡å›ãƒ‰ãƒªãƒ³ã‚¯ç„¡æ–™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body{
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",sans-serif;
      background:#f6f6f6;
      margin:0;
      padding:14px 12px 18px;
      text-align:center;
      color:#111;
    }
    .wrap{max-width:640px;margin:0 auto;}
    .card{
      background:#fff;
      border-radius:26px;
      padding:18px 16px 16px;
      box-shadow:0 10px 30px rgba(0,0,0,.07);
    }
    .title{font-size:24px;font-weight:900;margin:0 0 6px;}
    .sub{font-size:17px;font-weight:900;margin:0 0 6px;}
    .lead{font-size:17px;font-weight:900;margin:4px 0 6px;line-height:1.25;}
    .note{
      background:#fff3cd;
      border-radius:14px;
      padding:11px 12px;
      font-size:15px;
      font-weight:900;
      margin:6px 0 6px;
      line-height:1.35;
    }
    .muted{font-size:13px;color:#666;margin:4px 0;}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace;}
    .codeBig{
      font-size:28px;
      font-weight:900;
      letter-spacing:.08em;
      margin:8px 0 0;
    }
    .codeLine{font-size:13px;font-weight:800;color:#666;margin:0 0 6px;}
    .refLine{
      font-size:13px;
      font-weight:900;
      margin:2px 0 8px;
    }
    .refLine span{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#eef3ff;
    }
    .refBox{
      background:#f3f3f3;
      border-radius:14px;
      padding:10px 10px;
      margin:8px 0 6px;
      text-align:left;
      font-size:13px;
      font-weight:900;
    }
    .refRow{
      display:flex;
      gap:8px;
      margin-top:6px;
    }
    input{
      flex:1;
      padding:10px;
      border-radius:12px;
      border:1px solid #ccc;
      font-size:16px;
    }
    button{
      padding:10px 12px;
      border-radius:12px;
      border:0;
      background:#111;
      color:#fff;
      font-weight:900;
      font-size:15px;
    }
    .qr{
      width:100%;
      max-width:250px;
      margin:4px auto 0;
      display:block;
    }
    .footer{font-size:13px;color:#888;margin-top:6px;}

    @media (max-height: 700px) {
      .title{font-size:23px;}
      .lead{font-size:16px;}
      .note{font-size:14px; padding:10px 11px;}
      .codeBig{font-size:26px;}
      .qr{max-width:235px;}
      input{font-size:15px;}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <div class="title">ğŸ¥¤ æ¬¡å›ãƒ‰ãƒªãƒ³ã‚¯ç„¡æ–™</div>
    <div class="sub">2/24 LIVE ç‰¹å…¸</div>
    <div class="lead">ã“ã®ç”»é¢ã‚’ã‚¹ã‚¯ã‚·ãƒ§ä¿å­˜ã—ã¦ãã ã•ã„</div>

    <div class="note">
      2/24æ¥å ´æ™‚ã«ã“ã®ç”»é¢ã‚’è¦‹ã›ã‚‹ã¨<br>
      <strong>ãƒ‰ãƒªãƒ³ã‚¯1æ¯ç„¡æ–™ï¼ˆ1å›ï¼‰</strong> ğŸº<br>
      ã•ã‚‰ã«ã€<strong>å‹é”ã‚’é€£ã‚Œã¦ããŸã‚‰å‹é”ã‚‚1æ¯ç„¡æ–™</strong>
    </div>

    <div class="muted">â€» ã‚¹ã‚¿ãƒƒãƒ•ãŒèª­ã¿å–ã‚Šã¾ã™ï¼ˆãŠå®¢æ§˜ã¯æ“ä½œä¸è¦ï¼‰</div>

    <div class="codeBig mono" id="codeBig">----</div>
    <div class="codeLine" id="codeLine">code: ----</div>

    <!-- ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼ˆï¼ã“ã®äººã®uidï¼‰ -->
    <div class="refLine">ã‚ãªãŸã®ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼š<span class="mono" id="myRef">----</span></div>

    <!-- å‹é”ï¼ˆæ–°è¦ï¼‰å‘ã‘ï¼šç´¹ä»‹ã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆä»»æ„ï¼‰ -->
    <div class="refBox">
      å‹é”ã«èª˜ã‚ã‚ŒãŸäººã¯ã€ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ–‡å­—ï¼‰ã‚’å…¥åŠ›ã—ã¦ã€Œåæ˜ ã€ã—ã¦ã­
      <div class="refRow">
        <input id="refInput" class="mono" placeholder="ä¾‹ï¼šabcd" maxlength="4" inputmode="text" autocomplete="off" autocapitalize="characters">
        <button id="applyBtn" type="button">åæ˜ </button>
      </div>
    </div>

    <img id="qr" class="qr" alt="ã‚¹ã‚¿ãƒƒãƒ•èª­ã¿å–ã‚Šç”¨QR">
    <div class="footer">ã“ã®ç”»é¢ã¯å†ç™ºè¡Œã§ãã¾ã›ã‚“</div>
  </div>
</div>

<script>
  const params = new URLSearchParams(location.search);
  let spot = (params.get("spot") || "uk").toLowerCase().replace(/[^a-z0-9]/g,"").slice(0,2);

  const alphabet = "23456789ABCDEFGHJKLMNPQRSTUVWXYZ";
  const rand4 = () => {
    let s = "";
    for(let i=0;i<4;i++) s += alphabet[Math.floor(Math.random()*alphabet.length)];
    return s;
  };

  // ã“ã®äººè‡ªèº«ã®uidï¼ˆç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã«ã‚‚ä½¿ã†ï¼‰
  const uid = rand4();
  const token = uid + spot;

  // ç™ºè¡Œæ™‚åˆ»ï¼ˆUnixåˆ† â†’ base36ï¼‰
  const issuedMin = Math.floor(Date.now() / 60000);
  const t = issuedMin.toString(36);

  // ç´¹ä»‹è€…ï¼ˆå‹é”ã®uidï¼‰å…¥åŠ›ï¼šä»»æ„
  const cleanRef = (v) => (v || "")
    .toUpperCase()
    .replace(/[^A-Z0-9]/g,"")
    .slice(0,4);

  let ref = cleanRef(params.get("ref") || ""); // URLã§ã‚‚æ¸¡ã›ã‚‹ã‚ˆã†ã«ä¿é™º

  // redeem URLï¼ˆr=ç´¹ä»‹è€…uid ã‚’è¼‰ã›ã‚‹ï¼šç©ºãªã‚‰ä»˜ã‘ãªã„ï¼‰
  const base = location.origin + location.pathname.replace(/[^\/]+$/, "");

  function buildRedeemUrl(){
    const u = new URL(base + "redeem.html");
    u.searchParams.set("c", token);
    u.searchParams.set("t", t);
    if(ref) u.searchParams.set("r", ref);
    return u.toString();
  }

  function render(){
    document.getElementById("codeBig").textContent = uid.toLowerCase();
    document.getElementById("codeLine").textContent = `code: ${uid.toLowerCase()}-${spot}`;
    document.getElementById("myRef").textContent = uid.toLowerCase();

    const redeemUrl = buildRedeemUrl();
    document.getElementById("qr").src =
      "https://barcode.tec-it.com/barcode.ashx" +
      "?data=" + encodeURIComponent(redeemUrl) +
      "&code=QRCode";
  }

  // ãƒœã‚¿ãƒ³ã§refåæ˜ ï¼ˆQRã‚’ä½œã‚Šç›´ã™ï¼‰
  document.getElementById("applyBtn").addEventListener("click", () => {
    ref = cleanRef(document.getElementById("refInput").value);
    render();
  });

  render();
</script>
</body>
</html>
